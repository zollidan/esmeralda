server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Сбор логов Docker контейнеров
  - job_name: docker
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker
          __path__: /var/lib/docker/containers/*/*.log

    pipeline_stages:
      # Парсинг JSON логов Docker
      - json:
          expressions:
            output: log
            stream: stream
            attrs: attrs
            time: time

      # Извлечение Docker меток
      - json:
          source: attrs
          expressions:
            container_name: "com.docker.compose.service"
            service: "service"
            environment: "environment"

      # Установка меток для идентификации сервисов
      - labels:
          stream:
          container_name:
          service:
          environment:

      # Фильтрация только важных логов (ошибки, предупреждения)
      - match:
          selector: '{job="docker"}'
          stages:
            - regex:
                expression: "(?i).*(error|exception|fatal|fail|warning|warn|critical|traceback|stack trace).*"
                source: output
            - output:
                source: output

      # Добавление временной метки
      - timestamp:
          source: time
          format: RFC3339Nano

  # Сбор логов FastAPI приложения (если логи пишутся в файл)
  - job_name: fastapi
    static_configs:
      - targets:
          - localhost
        labels:
          job: fastapi
          service: web
          __path__: /var/log/app/*.log

  # Сбор логов Traefik
  - job_name: traefik
    static_configs:
      - targets:
          - localhost
        labels:
          job: traefik
          service: traefik
          __path__: /var/log/traefik/*.log

    pipeline_stages:
      # Парсинг access логов Traefik
      - regex:
          expression: '^(?P<remote_addr>\S+) \S+ \S+ \[(?P<time>[^\]]+)\] "(?P<method>\S+) (?P<path>\S+) (?P<protocol>\S+)" (?P<status>\d+) (?P<body_bytes_sent>\d+)'

      # Фильтрация только ошибок HTTP (4xx, 5xx)
      - match:
          selector: '{job="traefik"}'
          stages:
            - regex:
                expression: '^.*" (?P<status>[45]\d{2}) .*'
                source: output
            - labels:
                status:

  # Системные логи
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          __path__: /var/log/syslog

    pipeline_stages:
      # Фильтрация только критических системных событий
      - match:
          selector: '{job="system"}'
          stages:
            - regex:
                expression: "(?i).*(error|critical|emergency|alert|crit|emerg).*"
